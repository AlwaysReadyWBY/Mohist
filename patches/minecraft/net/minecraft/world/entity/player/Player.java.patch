--- a/net/minecraft/world/entity/player/Player.java
+++ b/net/minecraft/world/entity/player/Player.java
@@ -1,5 +_,6 @@
 package net.minecraft.world.entity.player;
 
+import com.google.common.base.Function;
 import com.google.common.collect.ImmutableList;
 import com.google.common.collect.ImmutableMap;
 import com.google.common.collect.Lists;
@@ -11,6 +_,8 @@
 import java.util.Map;
 import java.util.Optional;
 import java.util.OptionalInt;
+import java.util.concurrent.atomic.AtomicBoolean;
+import java.util.concurrent.atomic.AtomicReference;
 import java.util.function.Predicate;
 import javax.annotation.Nullable;
 import net.minecraft.Util;
@@ -18,7 +_,9 @@
 import net.minecraft.core.BlockPos;
 import net.minecraft.core.Direction;
 import net.minecraft.core.GlobalPos;
+import net.minecraft.core.particles.ParticleOptions;
 import net.minecraft.core.particles.ParticleTypes;
+import net.minecraft.core.registries.Registries;
 import net.minecraft.nbt.CompoundTag;
 import net.minecraft.nbt.ListTag;
 import net.minecraft.nbt.NbtOps;
@@ -112,9 +_,25 @@
 import net.minecraft.world.scores.PlayerTeam;
 import net.minecraft.world.scores.Scoreboard;
 import net.minecraft.world.scores.Team;
+import net.minecraftforge.common.ForgeHooks;
+import net.minecraftforge.event.ForgeEventFactory;
+import org.bukkit.Bukkit;
+import org.bukkit.craftbukkit.entity.CraftHumanEntity;
+import org.bukkit.craftbukkit.event.CraftEventFactory;
+import org.bukkit.craftbukkit.util.CraftVector;
+import org.bukkit.entity.Item;
+import org.bukkit.event.entity.EntityCombustByEntityEvent;
+import org.bukkit.event.entity.EntityDamageEvent;
+import org.bukkit.event.entity.EntityExhaustionEvent;
+import org.bukkit.event.entity.EntityKnockbackEvent;
+import org.bukkit.event.entity.EntityPotionEffectEvent;
+import org.bukkit.event.entity.EntityRegainHealthEvent;
+import org.bukkit.event.player.PlayerDropItemEvent;
+import org.bukkit.event.player.PlayerVelocityEvent;
 import org.slf4j.Logger;
 
-public abstract class Player extends LivingEntity {
+public abstract class Player extends LivingEntity implements net.minecraftforge.common.extensions.IForgePlayer {
+   public static final String PERSISTED_NBT_TAG = "PlayerPersisted";
     private static final Logger LOGGER = LogUtils.getLogger();
     public static final HumanoidArm DEFAULT_MAIN_HAND = HumanoidArm.RIGHT;
     public static final int DEFAULT_MODEL_CUSTOMIZATION = 0;
@@ -154,10 +_,10 @@
     protected static final EntityDataAccessor<CompoundTag> DATA_SHOULDER_RIGHT = SynchedEntityData.defineId(Player.class, EntityDataSerializers.COMPOUND_TAG);
     private long timeEntitySatOnShoulder;
     final Inventory inventory = new Inventory(this);
-    protected PlayerEnderChestContainer enderChestInventory = new PlayerEnderChestContainer();
-    public final InventoryMenu inventoryMenu;
-    public AbstractContainerMenu containerMenu;
-    protected FoodData foodData = new FoodData();
+   	protected PlayerEnderChestContainer enderChestInventory = new PlayerEnderChestContainer(this); // CraftBukkit - add "this" to constructor
+   	public final InventoryMenu inventoryMenu;
+   	public AbstractContainerMenu containerMenu;
+   	protected FoodData foodData = new FoodData(this); // CraftBukkit - add "this" to constructor
     protected int jumpTriggerTime;
     public float oBob;
     public float bob;
@@ -168,13 +_,13 @@
     public double xCloak;
     public double yCloak;
     public double zCloak;
-    public int sleepCounter;
+   	public int sleepCounter;
     protected boolean wasUnderwater;
     private final Abilities abilities = new Abilities();
     public int experienceLevel;
     public int totalExperience;
     public float experienceProgress;
-    protected int enchantmentSeed;
+   	public int enchantmentSeed;
     protected final float defaultFlySpeed = 0.02F;
     private int lastLevelUpTime;
     private final GameProfile gameProfile;
@@ -190,6 +_,19 @@
     @Nullable
     public Entity currentExplosionCause;
     public boolean ignoreFallDamageFromCurrentImpulse;
+    private final java.util.Collection<MutableComponent> prefixes = new java.util.LinkedList<>();
+    private final java.util.Collection<MutableComponent> suffixes = new java.util.LinkedList<>();
+    @Nullable private Pose forcedPose;
+
+   // CraftBukkit start
+   public boolean fauxSleeping;
+   public int oldLevel = -1;
+
+   @Override
+   public CraftHumanEntity getBukkitEntity() {
+      return (CraftHumanEntity) super.getBukkitEntity();
+   }
+   // CraftBukkit end
 
     public Player(Level p_250508_, BlockPos p_250289_, float p_251702_, GameProfile p_252153_) {
         super(EntityType.PLAYER, p_250508_);
@@ -222,7 +_,8 @@
             .add(Attributes.LUCK)
             .add(Attributes.BLOCK_INTERACTION_RANGE, 4.5)
             .add(Attributes.ENTITY_INTERACTION_RANGE, 3.0)
-            .add(Attributes.BLOCK_BREAK_SPEED);
+            .add(Attributes.BLOCK_BREAK_SPEED)
+            .add(Attributes.ATTACK_KNOCKBACK);
     }
 
     @Override
@@ -238,6 +_,7 @@
 
     @Override
     public void tick() {
+        net.minecraftforge.event.ForgeEventFactory.onPlayerPreTick(this);
         this.noPhysics = this.isSpectator();
         if (this.isSpectator()) {
             this.setOnGround(false);
@@ -253,7 +_,7 @@
                 this.sleepCounter = 100;
             }
 
-            if (!this.level().isClientSide && this.level().isDay()) {
+            if (!this.level().isClientSide && !net.minecraftforge.event.ForgeEventFactory.onSleepingTimeCheck(this, getSleepingPos())) {
                 this.stopSleepInBed(false, true);
             }
         } else if (this.sleepCounter > 0) {
@@ -308,6 +_,7 @@
         this.turtleHelmetTick();
         this.cooldowns.tick();
         this.updatePlayerPose();
+        net.minecraftforge.event.ForgeEventFactory.onPlayerPostTick(this);
     }
 
     @Override
@@ -335,6 +_,7 @@
     private void turtleHelmetTick() {
         ItemStack itemstack = this.getItemBySlot(EquipmentSlot.HEAD);
         if (itemstack.is(Items.TURTLE_HELMET) && !this.isEyeInFluid(FluidTags.WATER)) {
+            this.addEffectCause(EntityPotionEffectEvent.Cause.TURTLE_HELMET);
             this.addEffect(new MobEffectInstance(MobEffects.WATER_BREATHING, 200, 0, false, false, true));
         }
     }
@@ -387,6 +_,10 @@
     }
 
     protected void updatePlayerPose() {
+        if (forcedPose != null) {
+            this.setPose(forcedPose);
+            return;
+        }
         if (this.canPlayerFitWithinBlocksAndEntitiesWhen(Pose.SWIMMING)) {
             Pose pose;
             if (this.isFallFlying()) {
@@ -459,7 +_,7 @@
     }
 
     @Override
-    protected int getFireImmuneTicks() {
+    public int getFireImmuneTicks() {
         return 20;
     }
 
@@ -487,8 +_,14 @@
     public void rideTick() {
         if (!this.level().isClientSide && this.wantsToStopRiding() && this.isPassenger()) {
             this.stopRiding();
-            this.setShiftKeyDown(false);
-        } else {
+            // CraftBukkit start - SPIGOT-7316: no longer passenger, dismount and return
+            if (!this.isPassenger()) {
+                this.setShiftKeyDown(false);
+                return;
+            }
+        }
+        {
+            // CraftBukkit end
             super.rideTick();
             this.oBob = this.bob;
             this.bob = 0.0F;
@@ -510,6 +_,8 @@
 
         if (this.level().getDifficulty() == Difficulty.PEACEFUL && this.level().getGameRules().getBoolean(GameRules.RULE_NATURAL_REGENERATION)) {
             if (this.getHealth() < this.getMaxHealth() && this.tickCount % 20 == 0) {
+                // CraftBukkit - added regain reason of "REGEN" for filtering purposes.
+                this.heal$regainReason(EntityRegainHealthEvent.RegainReason.REGEN);
                 this.heal(1.0F);
             }
 
@@ -613,6 +_,7 @@
 
     @Override
     public void die(DamageSource p_36152_) {
+        if (net.minecraftforge.event.ForgeEventFactory.onLivingDeath(this, p_36152_)) return;
         super.die(p_36152_);
         this.reapplyPosition();
         if (!this.isSpectator()) {
@@ -667,8 +_,17 @@
 
     @Nullable
     public ItemEntity drop(ItemStack p_36177_, boolean p_36178_) {
-        return this.drop(p_36177_, false, p_36178_);
+        return net.minecraftforge.common.ForgeHooks.onPlayerTossEvent(this, p_36177_, p_36178_);
     }
+
+   // Mohist start
+   public AtomicBoolean callEventA = new AtomicBoolean(true);
+   @Nullable
+   public ItemEntity drop(ItemStack pDroppedItem, boolean pDropAround, boolean pIncludeThrowerName, boolean callEven) {
+      callEventA.set(callEven);
+      return drop(pDroppedItem, pDropAround, pIncludeThrowerName);
+   }
+   // Mohist end
 
     @Nullable
     public ItemEntity drop(ItemStack p_36179_, boolean p_36180_, boolean p_36181_) {
@@ -689,7 +_,7 @@
             if (p_36180_) {
                 float f = this.random.nextFloat() * 0.5F;
                 float f1 = this.random.nextFloat() * (float) (Math.PI * 2);
-                itementity.setDeltaMovement((double)(-Mth.sin(f1) * f), 0.2F, (double)(Mth.cos(f1) * f));
+                itementity.setDeltaMovement((double) (-Mth.sin(f1) * f), 0.2F, (double) (Mth.cos(f1) * f));
             } else {
                 float f7 = 0.3F;
                 float f8 = Mth.sin(this.getXRot() * (float) (Math.PI / 180.0));
@@ -699,17 +_,49 @@
                 float f5 = this.random.nextFloat() * (float) (Math.PI * 2);
                 float f6 = 0.02F * this.random.nextFloat();
                 itementity.setDeltaMovement(
-                    (double)(-f3 * f2 * 0.3F) + Math.cos((double)f5) * (double)f6,
-                    (double)(-f8 * 0.3F + 0.1F + (this.random.nextFloat() - this.random.nextFloat()) * 0.1F),
-                    (double)(f4 * f2 * 0.3F) + Math.sin((double)f5) * (double)f6
+                        (double) (-f3 * f2 * 0.3F) + Math.cos((double) f5) * (double) f6,
+                        (double) (-f8 * 0.3F + 0.1F + (this.random.nextFloat() - this.random.nextFloat()) * 0.1F),
+                        (double) (f4 * f2 * 0.3F) + Math.sin((double) f5) * (double) f6
                 );
             }
+
+            // CraftBukkit start - fire PlayerDropItemEvent
+            if (!callEventA.getAndSet(true)) { // SPIGOT-2942: Add boolean to call event
+                return itementity;
+            }
+            org.bukkit.entity.Player player = (org.bukkit.entity.Player) this.getBukkitEntity();
+            Item drop = (Item) itementity.getBukkitEntity();
+
+            PlayerDropItemEvent event = new PlayerDropItemEvent(player, drop);
+            this.level.getCraftServer().getPluginManager().callEvent(event);
+
+            if (event.isCancelled()) {
+                org.bukkit.inventory.ItemStack cur = player.getInventory().getItemInHand();
+                if (p_36181_ && (cur == null || cur.getAmount() == 0)) {
+                    // The complete stack was dropped
+                    player.getInventory().setItemInHand(drop.getItemStack());
+                } else if (p_36181_ && cur.isSimilar(drop.getItemStack()) && cur.getAmount() < cur.getMaxStackSize() && drop.getItemStack().getAmount() == 1) {
+                    // Only one item is dropped
+                    cur.setAmount(cur.getAmount() + 1);
+                    player.getInventory().setItemInHand(cur);
+                } else {
+                    // Fallback
+                    player.getInventory().addItem(drop.getItemStack());
+                }
+                return null;
+            }
+            // CraftBukkit end
 
             return itementity;
         }
     }
 
+    /** @deprecated Use {@link #getDestroySpeed(BlockState,BlockPos) */
     public float getDestroySpeed(BlockState p_36282_) {
+        return getDestroySpeed(p_36282_, null);
+    }
+
+    public float getDestroySpeed(BlockState p_36282_, @Nullable BlockPos pos) {
         float f = this.inventory.getDestroySpeed(p_36282_);
         if (f > 1.0F) {
             int i = EnchantmentHelper.getBlockEfficiency(this);
@@ -741,11 +_,14 @@
             f /= 5.0F;
         }
 
+        f = net.minecraftforge.event.ForgeEventFactory.getBreakSpeed(this, p_36282_, f, pos);
+
         return f;
     }
 
     public boolean hasCorrectToolForDrops(BlockState p_36299_) {
-        return !p_36299_.requiresCorrectToolForDrops() || this.inventory.getSelected().isCorrectToolForDrops(p_36299_);
+        var vanilla = !p_36299_.requiresCorrectToolForDrops() || this.inventory.getSelected().isCorrectToolForDrops(p_36299_);
+        return net.minecraftforge.event.ForgeEventFactory.doPlayerHarvestCheck(this, p_36299_, vanilla);
     }
 
     @Override
@@ -844,6 +_,7 @@
 
     @Override
     public boolean hurt(DamageSource p_36154_, float p_36155_) {
+        if (!net.minecraftforge.common.ForgeHooks.onPlayerAttack(this, p_36154_, p_36155_)) return false;
         if (this.isInvulnerableTo(p_36154_)) {
             return false;
         } else if (this.abilities.invulnerable && !p_36154_.is(DamageTypeTags.BYPASSES_INVULNERABILITY)) {
@@ -854,12 +_,12 @@
                 return false;
             } else {
                 if (!this.level().isClientSide) {
-                    this.removeEntitiesOnShoulder();
+                    // this.removeEntitiesOnShoulder(); // CraftBukkit - moved down
                 }
 
                 if (p_36154_.scalesWithDifficulty()) {
                     if (this.level().getDifficulty() == Difficulty.PEACEFUL) {
-                        p_36155_ = 0.0F;
+                        return false; // CraftBukkit - f = 0.0f -> return false
                     }
 
                     if (this.level().getDifficulty() == Difficulty.EASY) {
@@ -871,7 +_,13 @@
                     }
                 }
 
-                return p_36155_ == 0.0F ? false : super.hurt(p_36154_, p_36155_);
+                // CraftBukkit start - Don't filter out 0 damage
+                boolean damaged = super.hurt(p_36154_, p_36155_);
+                if (damaged) {
+                    this.removeEntitiesOnShoulder();
+                }
+                return damaged;
+                // CraftBukkit end
             }
         }
     }
@@ -879,7 +_,7 @@
     @Override
     protected void blockUsingShield(LivingEntity p_36295_) {
         super.blockUsingShield(p_36295_);
-        if (p_36295_.canDisableShield()) {
+        if (p_36295_.getMainHandItem().canDisableShield(this.useItem, this, p_36295_)) {
             this.disableShield();
         }
     }
@@ -890,13 +_,29 @@
     }
 
     public boolean canHarmPlayer(Player p_36169_) {
-        Team team = this.getTeam();
-        Team team1 = p_36169_.getTeam();
-        if (team == null) {
-            return true;
+        // CraftBukkit start - Change to check OTHER player's scoreboard team according to API
+        // To summarize this method's logic, it's "Can parameter hurt this"
+        org.bukkit.scoreboard.Team team;
+        if (p_36169_ instanceof ServerPlayer) {
+            ServerPlayer thatPlayer = (ServerPlayer) p_36169_;
+            team = thatPlayer.getBukkitEntity().getScoreboard().getPlayerTeam(thatPlayer.getBukkitEntity());
+            if (team == null || team.allowFriendlyFire()) {
+                return true;
+            }
         } else {
-            return !team.isAlliedTo(team1) ? true : team.isAllowFriendlyFire();
-        }
+            // This should never be called, but is implemented anyway
+            org.bukkit.OfflinePlayer thisPlayer = p_36169_.level().getCraftServer().getOfflinePlayer(p_36169_.getScoreboardName());
+            team = p_36169_.level().getCraftServer().getScoreboardManager().getMainScoreboard().getPlayerTeam(thisPlayer);
+            if (team == null || team.allowFriendlyFire()) {
+                return true;
+            }
+        }
+
+        if (this instanceof ServerPlayer) {
+            return !team.hasPlayer(((ServerPlayer) this).getBukkitEntity());
+        }
+        return !team.hasPlayer(this.level().getCraftServer().getOfflinePlayer(this.getScoreboardName()));
+        // CraftBukkit end
     }
 
     @Override
@@ -911,7 +_,7 @@
 
     @Override
     protected void hurtCurrentlyUsedShield(float p_36383_) {
-        if (this.useItem.is(Items.SHIELD)) {
+        if (this.useItem.canPerformAction(net.minecraftforge.common.ToolActions.SHIELD_BLOCK)) {
             if (!this.level().isClientSide) {
                 this.awardStat(Stats.ITEM_USED.get(this.useItem.getItem()));
             }
@@ -934,31 +_,178 @@
         }
     }
 
-    @Override
-    protected void actuallyHurt(DamageSource p_36312_, float p_36313_) {
-        if (!this.isInvulnerableTo(p_36312_)) {
-            p_36313_ = this.getDamageAfterArmorAbsorb(p_36312_, p_36313_);
-            p_36313_ = this.getDamageAfterMagicAbsorb(p_36312_, p_36313_);
-            float f1 = Math.max(p_36313_ - this.getAbsorptionAmount(), 0.0F);
-            this.setAbsorptionAmount(this.getAbsorptionAmount() - (p_36313_ - f1));
-            float f = p_36313_ - f1;
-            if (f > 0.0F && f < 3.4028235E37F) {
-                this.awardStat(Stats.DAMAGE_ABSORBED, Math.round(f * 10.0F));
-            }
-
-            if (f1 != 0.0F) {
-                this.causeFoodExhaustion(p_36312_.getFoodExhaustion());
-                this.getCombatTracker().recordDamage(p_36312_, f1);
-                this.setHealth(this.getHealth() - f1);
-                if (f1 < 3.4028235E37F) {
-                    this.awardStat(Stats.DAMAGE_TAKEN, Math.round(f1 * 10.0F));
-                }
-
-                this.gameEvent(GameEvent.ENTITY_DAMAGE);
-            }
-        }
-    }
-
+   protected boolean damageEntity0(DamageSource damagesource, float f) { // void -> boolean
+      return super.damageEntity0(damagesource, f);
+   }
+
+   protected void actuallyHurt(DamageSource p_36312_, float p_36313_) {
+      if (!this.isInvulnerableTo(p_36312_)) {
+         // Check if entity is a "human" aka player
+         final boolean human = this instanceof Player;
+         p_36313_ = ForgeHooks.onLivingHurt(this, p_36312_, p_36313_);
+         // If the damage is negative return true
+         if (p_36313_ < 0) {
+            this.canDamage.set(true);
+            return;
+         }
+         final float originalDamage = p_36313_;
+
+         Function<Double, Double> hardHat = f -> {
+            if (p_36312_.is(DamageTypeTags.DAMAGES_HELMET)  && !this.getItemBySlot(EquipmentSlot.HEAD).isEmpty()) {
+               return -(f - (f * 0.75F));
+            }
+            return -0.0;
+         };
+         float hardHatModifier = hardHat.apply((double) p_36313_).floatValue();
+         p_36313_ += hardHatModifier;
+
+         Function<Double, Double> blocking;
+         boolean shieldTakesDamage = false;
+         if (this.isDamageSourceBlocked(p_36312_)) {
+            var shieldEvent = ForgeEventFactory.onShieldBlock(this, p_36312_, p_36313_);
+            if (!shieldEvent.isCanceled()) {
+               var blocked = shieldEvent.getBlockedDamage();
+               shieldTakesDamage = shieldEvent.shieldTakesDamage();
+               blocking = f13 -> -(double) blocked;
+            } else {
+               blocking = f13 -> 0d;
+            }
+         } else {
+            blocking = f13 -> 0d;
+         }
+         float blockingModifier = blocking.apply((double) p_36313_).floatValue();
+         p_36313_ += blockingModifier;
+
+         Function<Double, Double> armor = f -> -(f - this.getDamageAfterArmorAbsorb(p_36312_, f.floatValue()));
+         float armorModifier = armor.apply((double) p_36313_).floatValue();
+         p_36313_ += armorModifier;
+
+         Function<Double, Double> resistance = f -> {
+            if (!p_36312_.is(DamageTypeTags.BYPASSES_EFFECTS) && this.hasEffect(MobEffects.DAMAGE_RESISTANCE) && !p_36312_.is(DamageTypeTags.BYPASSES_RESISTANCE)) {
+               int i = (this.getEffect(MobEffects.DAMAGE_RESISTANCE).getAmplifier() + 1) * 5;
+               int j = 25 - i;
+               float f1 = f.floatValue() * (float) j;
+               return -(f - (f1 / 25.0F));
+            }
+            return -0.0;
+         };
+         float resistanceModifier = resistance.apply((double) p_36313_).floatValue();
+         p_36313_ += resistanceModifier;
+
+         // Mohist start
+         float mohist = this.getDamageAfterMagicAbsorb(p_36312_, p_36313_);
+         float magicModifier = -(p_36313_ - mohist);
+         Function<Double, Double> magic = f -> (double) magicModifier;
+         p_36313_ += magicModifier;
+         // Mohist end
+
+         Function<Double, Double> absorption = f -> -(Math.max(f - Math.max(f - this.getAbsorptionAmount(), 0.0F), 0.0F));
+         float absorptionModifier = absorption.apply((double) p_36313_).floatValue();
+
+         EntityDamageEvent event = CraftEventFactory.handleLivingEntityDamageEvent(this, p_36312_, originalDamage, hardHatModifier, blockingModifier, armorModifier, resistanceModifier, magicModifier, absorptionModifier, hardHat, blocking, armor, resistance, magic, absorption);
+         if (p_36312_.getEntity() instanceof Player) {
+            ((Player) p_36312_.getEntity()).resetAttackStrengthTicker(); // Moved from Player in order to make the cooldown reset get called after the damage event is fired
+         }
+         if (event.isCancelled()) {
+            this.canDamage.set(false);
+            return;
+         }
+
+         p_36313_ = (float) event.getFinalDamage();
+
+         // Resistance
+         if (event.getDamage(EntityDamageEvent.DamageModifier.RESISTANCE) < 0) {
+            float f3 = (float) -event.getDamage(EntityDamageEvent.DamageModifier.RESISTANCE);
+            if (f3 > 0.0F && f3 < 3.4028235E37F) {
+               if (this instanceof ServerPlayer) {
+                  ((ServerPlayer) this).awardStat(Stats.DAMAGE_RESISTED, Math.round(f3 * 10.0F));
+               } else if (p_36312_.getEntity() instanceof ServerPlayer serverPlayer) {
+                  serverPlayer.awardStat(Stats.DAMAGE_DEALT_RESISTED, Math.round(f3 * 10.0F));
+               }
+            }
+         }
+
+         // Apply damage to helmet
+         if (p_36312_.is(DamageTypeTags.DAMAGES_HELMET) && !this.getItemBySlot(EquipmentSlot.HEAD).isEmpty()) {
+            this.hurtHelmet(p_36312_, p_36313_);
+         }
+
+         // Apply damage to armor
+         if (!p_36312_.is(DamageTypeTags.BYPASSES_ARMOR)) {
+            float armorDamage = (float) (event.getDamage() + event.getDamage(EntityDamageEvent.DamageModifier.BLOCKING) + event.getDamage(EntityDamageEvent.DamageModifier.HARD_HAT));
+            this.hurtArmor(p_36312_, armorDamage);
+         }
+
+         // Apply blocking code // PAIL: steal from above
+         if (event.getDamage(EntityDamageEvent.DamageModifier.BLOCKING) < 0) {
+            this.level().broadcastEntityEvent(this, (byte) 29); // SPIGOT-4635 - shield damage sound
+            if (shieldTakesDamage) {
+               this.hurtCurrentlyUsedShield((float) -event.getDamage(EntityDamageEvent.DamageModifier.BLOCKING));
+            }
+            Entity entity = p_36312_.getDirectEntity();
+            if (entity instanceof LivingEntity living) {
+               this.blockUsingShield(living);
+            }
+         }
+
+         absorptionModifier = (float) -event.getDamage(EntityDamageEvent.DamageModifier.ABSORPTION);
+         this.setAbsorptionAmount(Math.max(this.getAbsorptionAmount() - absorptionModifier, 0.0F));
+         float f2 = absorptionModifier;
+
+         if (f2 > 0.0F && f2 < 3.4028235E37F && this instanceof Player) {
+            ((Player) this).awardStat(Stats.DAMAGE_ABSORBED, Math.round(f2 * 10.0F));
+         }
+         if (f2 > 0.0F && f2 < 3.4028235E37F && p_36312_.getEntity() instanceof ServerPlayer) {
+            ((ServerPlayer) p_36312_.getEntity()).awardStat(Stats.DAMAGE_DEALT_ABSORBED, Math.round(f2 * 10.0F));
+         }
+
+         p_36313_ = net.minecraftforge.common.ForgeHooks.onLivingDamage(this, p_36312_, p_36313_);
+
+         if (p_36313_ > 0 || !human) {
+            if (human) {
+               // PAIL: Be sure to drag all this code from the Player subclass each update.
+               ((Player) this).exhaustionReason(org.bukkit.event.entity.EntityExhaustionEvent.ExhaustionReason.DAMAGED);
+               ((Player) this).causeFoodExhaustion(p_36312_.getFoodExhaustion());
+               if (p_36313_ < 3.4028235E37F) {
+                  ((Player) this).awardStat(Stats.DAMAGE_TAKEN, Math.round(p_36313_ * 10.0F));
+               }
+            }
+            // CraftBukkit end
+            float f1 = this.getHealth();
+            this.getCombatTracker().recordDamage(p_36312_, p_36313_);
+            this.setHealth(f1 - p_36313_); // Forge: moved to fix MC-121048
+            // CraftBukkit start
+            if (!human) {
+               this.setAbsorptionAmount(this.getAbsorptionAmount() - p_36313_);
+            }
+            this.gameEvent(GameEvent.ENTITY_DAMAGE, p_36312_.getEntity());
+            this.canDamage.set(true);
+            return;
+         } else {
+            // Duplicate triggers if blocking
+            if (event.getDamage(EntityDamageEvent.DamageModifier.BLOCKING) < 0) {
+               if (this instanceof ServerPlayer serverPlayer) {
+                  CriteriaTriggers.ENTITY_HURT_PLAYER.trigger(serverPlayer, p_36312_, p_36313_, originalDamage, true);
+                  f2 = (float) -event.getDamage(EntityDamageEvent.DamageModifier.BLOCKING);
+                  if (f2 > 0.0F && f2 < 3.4028235E37F) {
+                     serverPlayer.awardStat(Stats.DAMAGE_BLOCKED_BY_SHIELD, Math.round(originalDamage * 10.0F));
+                  }
+               }
+               if (p_36312_.getEntity() instanceof ServerPlayer serverPlayer) {
+                  CriteriaTriggers.PLAYER_HURT_ENTITY.trigger(serverPlayer, this, p_36312_, p_36313_, originalDamage, true);
+               }
+               this.canDamage.set(false);
+               return;
+            } else {
+               boolean flag = originalDamage > 0;
+               this.canDamage.set(flag);
+               return;
+            }
+            // CraftBukkit end
+         }
+      }
+      this.canDamage.set(false);
+   }
     @Override
     protected boolean onSoulSpeedBlock() {
         return !this.abilities.flying && super.onSoulSpeedBlock();
@@ -1004,6 +_,10 @@
 
             return InteractionResult.PASS;
         } else {
+            var event = net.minecraftforge.event.ForgeEventFactory.onEntityInteract(this, p_36158_, p_36159_);
+            if (event.isCanceled()) {
+                return event.getCancellationResult();
+            }
             ItemStack itemstack = this.getItemInHand(p_36159_);
             ItemStack itemstack1 = itemstack.copy();
             InteractionResult interactionresult = p_36158_.interact(this, p_36159_);
@@ -1012,6 +_,10 @@
                     itemstack.setCount(itemstack1.getCount());
                 }
 
+                if (!this.abilities.instabuild && itemstack.isEmpty()) {
+                    net.minecraftforge.event.ForgeEventFactory.onPlayerDestroyItem(this, itemstack1, getSlotForHand(p_36159_));
+                }
+
                 return interactionresult;
             } else {
                 if (!itemstack.isEmpty() && p_36158_ instanceof LivingEntity) {
@@ -1023,6 +_,7 @@
                     if (interactionresult1.consumesAction()) {
                         this.level().gameEvent(GameEvent.ENTITY_INTERACT, p_36158_.position(), GameEvent.Context.of(this));
                         if (itemstack.isEmpty() && !this.abilities.instabuild) {
+                            net.minecraftforge.event.ForgeEventFactory.onPlayerDestroyItem(this, itemstack1, getSlotForHand(p_36159_));
                             this.setItemInHand(p_36159_, ItemStack.EMPTY);
                         }
 
@@ -1120,183 +_,225 @@
                 )
             );
     }
-
     public void attack(Entity p_36347_) {
-        if (p_36347_.isAttackable()) {
-            if (!p_36347_.skipAttackInteraction(this)) {
-                float f = (float)this.getAttributeValue(Attributes.ATTACK_DAMAGE);
-                float f1 = EnchantmentHelper.getDamageBonus(this.getMainHandItem(), p_36347_.getType());
-                float f2 = this.getAttackStrengthScale(0.5F);
-                f *= 0.2F + f2 * f2 * 0.8F;
-                f1 *= f2;
-                this.resetAttackStrengthTicker();
-                if (p_36347_.getType().is(EntityTypeTags.REDIRECTABLE_PROJECTILE) && p_36347_ instanceof Projectile projectile) {
-                    projectile.deflect(ProjectileDeflection.AIM_DEFLECT, this, this, true);
-                } else {
-                    if (f > 0.0F || f1 > 0.0F) {
-                        boolean flag = f2 > 0.9F;
-                        boolean flag1 = false;
-                        int i = 0;
-                        i += EnchantmentHelper.getKnockbackBonus(this);
-                        if (this.isSprinting() && flag) {
-                            this.level().playSound(null, this.getX(), this.getY(), this.getZ(), SoundEvents.PLAYER_ATTACK_KNOCKBACK, this.getSoundSource(), 1.0F, 1.0F);
-                            i++;
-                            flag1 = true;
-                        }
-
-                        f += this.getItemInHand(InteractionHand.MAIN_HAND).getItem().getAttackDamageBonus(this, f);
-                        boolean flag2 = flag
-                            && this.fallDistance > 0.0F
-                            && !this.onGround()
-                            && !this.onClimbable()
-                            && !this.isInWater()
-                            && !this.hasEffect(MobEffects.BLINDNESS)
-                            && !this.isPassenger()
-                            && p_36347_ instanceof LivingEntity
-                            && !this.isSprinting();
-                        if (flag2) {
-                            f *= 1.5F;
-                        }
-
-                        f += f1;
-                        boolean flag3 = false;
-                        double d0 = (double)(this.walkDist - this.walkDistO);
-                        if (flag && !flag2 && !flag1 && this.onGround() && d0 < (double)this.getSpeed()) {
-                            ItemStack itemstack = this.getItemInHand(InteractionHand.MAIN_HAND);
-                            if (itemstack.getItem() instanceof SwordItem) {
-                                flag3 = true;
-                            }
-                        }
-
-                        float f4 = 0.0F;
-                        boolean flag4 = false;
-                        int j = EnchantmentHelper.getFireAspect(this);
-                        if (p_36347_ instanceof LivingEntity) {
-                            f4 = ((LivingEntity)p_36347_).getHealth();
-                            if (j > 0 && !p_36347_.isOnFire()) {
-                                flag4 = true;
-                                p_36347_.igniteForSeconds(1);
-                            }
-                        }
-
-                        Vec3 vec3 = p_36347_.getDeltaMovement();
-                        boolean flag5 = p_36347_.hurt(this.damageSources().playerAttack(this), f);
-                        if (flag5) {
-                            if (i > 0) {
-                                if (p_36347_ instanceof LivingEntity) {
-                                    ((LivingEntity)p_36347_)
-                                        .knockback(
-                                            (double)((float)i * 0.5F),
-                                            (double)Mth.sin(this.getYRot() * (float) (Math.PI / 180.0)),
-                                            (double)(-Mth.cos(this.getYRot() * (float) (Math.PI / 180.0)))
-                                        );
-                                } else {
-                                    p_36347_.push(
-                                        (double)(-Mth.sin(this.getYRot() * (float) (Math.PI / 180.0)) * (float)i * 0.5F),
-                                        0.1,
-                                        (double)(Mth.cos(this.getYRot() * (float) (Math.PI / 180.0)) * (float)i * 0.5F)
+       if (!net.minecraftforge.common.ForgeHooks.onPlayerAttackTarget(this, p_36347_)) return;
+       if (p_36347_.isAttackable()) {
+          if (!p_36347_.skipAttackInteraction(this)) {
+             float f = (float) this.getAttributeValue(Attributes.ATTACK_DAMAGE);
+             float f1 = EnchantmentHelper.getDamageBonus(this.getMainHandItem(), p_36347_.getType());
+             float f2 = this.getAttackStrengthScale(0.5F);
+             f *= 0.2F + f2 * f2 * 0.8F;
+             f1 *= f2;
+             if (p_36347_.getType().is(EntityTypeTags.REDIRECTABLE_PROJECTILE) && p_36347_ instanceof Projectile projectile) {
+                projectile.deflect(ProjectileDeflection.AIM_DEFLECT, this, this, true);
+             } else {
+                if (f > 0.0F || f1 > 0.0F) {
+                   boolean flag = f2 > 0.9F;
+                   boolean flag1 = false;
+                   float i = (float) this.getAttributeValue(Attributes.ATTACK_KNOCKBACK); // Forge: Initialize this value to the attack knockback attribute of the player, which is by default 0
+                   i += EnchantmentHelper.getKnockbackBonus(this);
+                   if (this.isSprinting() && flag) {
+                      this.level().playSound(null, this.getX(), this.getY(), this.getZ(), SoundEvents.PLAYER_ATTACK_KNOCKBACK, this.getSoundSource(), 1.0F, 1.0F);
+                      i++;
+                      flag1 = true;
+                   }
+
+                   f += this.getItemInHand(InteractionHand.MAIN_HAND).getItem().getAttackDamageBonus(this, f);
+                   boolean flag2 = flag
+                           && this.fallDistance > 0.0F
+                           && !this.onGround()
+                           && !this.onClimbable()
+                           && !this.isInWater()
+                           && !this.hasEffect(MobEffects.BLINDNESS)
+                           && !this.isPassenger()
+                           && p_36347_ instanceof LivingEntity
+                           && !this.isSprinting();
+                   var hitResult = net.minecraftforge.common.ForgeHooks.getCriticalHit(this, p_36347_, flag2, flag2 ? 1.5F : 1.0F);
+                   flag2 = hitResult != null;
+                   if (flag2) {
+                      f *= hitResult.getDamageModifier();
+                   }
+
+                   f += f1;
+                   boolean flag3 = false;
+                   double d0 = (double) (this.walkDist - this.walkDistO);
+                   if (flag && !flag2 && !flag1 && this.onGround() && d0 < (double) this.getSpeed()) {
+                      ItemStack itemstack = this.getItemInHand(InteractionHand.MAIN_HAND);
+                      if (itemstack.canPerformAction(net.minecraftforge.common.ToolActions.SWORD_SWEEP)) {
+                         flag3 = true;
+                      }
+                   }
+
+                   float f4 = 0.0F;
+                   boolean flag4 = false;
+                   int j = EnchantmentHelper.getFireAspect(this);
+                   if (p_36347_ instanceof LivingEntity) {
+                      f4 = ((LivingEntity) p_36347_).getHealth();
+                      if (j > 0 && !p_36347_.isOnFire()) {
+                         // CraftBukkit start - Call a combust event when somebody hits with a fire enchanted item
+                         EntityCombustByEntityEvent combustEvent = new EntityCombustByEntityEvent(this.getBukkitEntity(), p_36347_.getBukkitEntity(), 1);
+                         org.bukkit.Bukkit.getPluginManager().callEvent(combustEvent);
+
+                         if (!combustEvent.isCancelled()) {
+                            flag4 = true;
+                            p_36347_.igniteForSeconds(combustEvent.getDuration(), false);
+                         }
+                         // CraftBukkit end
+                      }
+                   }
+
+                   Vec3 vec3 = p_36347_.getDeltaMovement();
+                   boolean flag5 = p_36347_.hurt(this.damageSources().playerAttack(this), f);
+                   if (flag5) {
+                      if (i > 0) {
+                         if (p_36347_ instanceof LivingEntity) {
+                            ((LivingEntity) p_36347_)
+                                    .knockback(
+                                            (double) ((float) i * 0.5F),
+                                            (double) Mth.sin(this.getYRot() * (float) (Math.PI / 180.0)),
+                                            (double) (-Mth.cos(this.getYRot() * (float) (Math.PI / 180.0)))
                                     );
-                                }
-
-                                this.setDeltaMovement(this.getDeltaMovement().multiply(0.6, 1.0, 0.6));
-                                this.setSprinting(false);
-                            }
-
-                            if (flag3) {
-                                float f3 = 1.0F + EnchantmentHelper.getSweepingDamageRatio(this) * f;
-
-                                for (LivingEntity livingentity : this.level().getEntitiesOfClass(LivingEntity.class, p_36347_.getBoundingBox().inflate(1.0, 0.25, 1.0))) {
-                                    if (livingentity != this
-                                        && livingentity != p_36347_
-                                        && !this.isAlliedTo(livingentity)
-                                        && (!(livingentity instanceof ArmorStand) || !((ArmorStand)livingentity).isMarker())
-                                        && this.distanceToSqr(livingentity) < 9.0) {
-                                        livingentity.knockback(
-                                            0.4F,
-                                            (double)Mth.sin(this.getYRot() * (float) (Math.PI / 180.0)),
-                                            (double)(-Mth.cos(this.getYRot() * (float) (Math.PI / 180.0)))
-                                        );
-                                        livingentity.hurt(this.damageSources().playerAttack(this), f3);
-                                    }
-                                }
-
-                                this.level()
-                                    .playSound(null, this.getX(), this.getY(), this.getZ(), SoundEvents.PLAYER_ATTACK_SWEEP, this.getSoundSource(), 1.0F, 1.0F);
-                                this.sweepAttack();
-                            }
-
-                            if (p_36347_ instanceof ServerPlayer && p_36347_.hurtMarked) {
-                                ((ServerPlayer)p_36347_).connection.send(new ClientboundSetEntityMotionPacket(p_36347_));
-                                p_36347_.hurtMarked = false;
-                                p_36347_.setDeltaMovement(vec3);
-                            }
-
-                            if (flag2) {
-                                this.level()
-                                    .playSound(null, this.getX(), this.getY(), this.getZ(), SoundEvents.PLAYER_ATTACK_CRIT, this.getSoundSource(), 1.0F, 1.0F);
-                                this.crit(p_36347_);
-                            }
-
-                            if (!flag2 && !flag3) {
-                                if (flag) {
-                                    this.level()
-                                        .playSound(null, this.getX(), this.getY(), this.getZ(), SoundEvents.PLAYER_ATTACK_STRONG, this.getSoundSource(), 1.0F, 1.0F);
-                                } else {
-                                    this.level()
-                                        .playSound(null, this.getX(), this.getY(), this.getZ(), SoundEvents.PLAYER_ATTACK_WEAK, this.getSoundSource(), 1.0F, 1.0F);
-                                }
-                            }
-
-                            if (f1 > 0.0F) {
-                                this.magicCrit(p_36347_);
-                            }
-
-                            this.setLastHurtMob(p_36347_);
-                            if (p_36347_ instanceof LivingEntity) {
-                                EnchantmentHelper.doPostHurtEffects((LivingEntity)p_36347_, this);
-                            }
-
-                            EnchantmentHelper.doPostDamageEffects(this, p_36347_);
-                            ItemStack itemstack1 = this.getMainHandItem();
-                            Entity entity = p_36347_;
-                            if (p_36347_ instanceof EnderDragonPart) {
-                                entity = ((EnderDragonPart)p_36347_).parentMob;
-                            }
-
-                            if (!this.level().isClientSide && !itemstack1.isEmpty() && entity instanceof LivingEntity) {
-                                itemstack1.hurtEnemy((LivingEntity)entity, this);
-                                if (itemstack1.isEmpty()) {
-                                    this.setItemInHand(InteractionHand.MAIN_HAND, ItemStack.EMPTY);
-                                }
-                            }
-
-                            if (p_36347_ instanceof LivingEntity) {
-                                float f5 = f4 - ((LivingEntity)p_36347_).getHealth();
-                                this.awardStat(Stats.DAMAGE_DEALT, Math.round(f5 * 10.0F));
-                                if (j > 0) {
-                                    p_36347_.igniteForSeconds(j * 4);
-                                }
-
-                                if (this.level() instanceof ServerLevel && f5 > 2.0F) {
-                                    int k = (int)((double)f5 * 0.5);
-                                    ((ServerLevel)this.level())
-                                        .sendParticles(
+                         } else {
+                            p_36347_.push(
+                                    (double) (-Mth.sin(this.getYRot() * (float) (Math.PI / 180.0)) * (float) i * 0.5F),
+                                    0.1,
+                                    (double) (Mth.cos(this.getYRot() * (float) (Math.PI / 180.0)) * (float) i * 0.5F)
+                            );
+                         }
+
+                         this.setDeltaMovement(this.getDeltaMovement().multiply(0.6, 1.0, 0.6));
+                         this.setSprinting(false);
+                      }
+
+                      if (flag3) {
+                         float f3 = 1.0F + EnchantmentHelper.getSweepingDamageRatio(this) * f;
+
+                         for (LivingEntity livingentity : this.level().getEntitiesOfClass(LivingEntity.class, this.getItemInHand(InteractionHand.MAIN_HAND).getSweepHitBox(this, p_36347_))) {
+                            if (livingentity != this
+                                    && livingentity != p_36347_
+                                    && !this.isAlliedTo(livingentity)
+                                    && (!(livingentity instanceof ArmorStand) || !((ArmorStand) livingentity).isMarker())
+                                    && this.distanceToSqr(livingentity) < 9.0) {
+                               livingentity.knockback(
+                                       0.4F,
+                                       (double) Mth.sin(this.getYRot() * (float) (Math.PI / 180.0)),
+                                       (double) (-Mth.cos(this.getYRot() * (float) (Math.PI / 180.0)))
+                               );
+                               livingentity.hurt(this.damageSources().playerAttack(this), f3);
+                            }
+                         }
+
+                         this.level()
+                                 .playSound(null, this.getX(), this.getY(), this.getZ(), SoundEvents.PLAYER_ATTACK_SWEEP, this.getSoundSource(), 1.0F, 1.0F);
+                         this.sweepAttack();
+                      }
+
+                      if (p_36347_ instanceof ServerPlayer && p_36347_.hurtMarked) {
+                         // CraftBukkit start - Add Velocity Event
+                         boolean cancelled = false;
+                         org.bukkit.entity.Player player = (org.bukkit.entity.Player) p_36347_.getBukkitEntity();
+                         org.bukkit.util.Vector velocity = CraftVector.toBukkit(vec3);
+
+                         PlayerVelocityEvent event = new PlayerVelocityEvent(player, velocity.clone());
+                         Bukkit.getPluginManager().callEvent(event);
+
+                         if (event.isCancelled()) {
+                            cancelled = true;
+                         } else if (!velocity.equals(event.getVelocity())) {
+                            player.setVelocity(event.getVelocity());
+                         }
+
+                         if (!cancelled) {
+                            ((ServerPlayer) p_36347_).connection.send(new ClientboundSetEntityMotionPacket(p_36347_));
+                            p_36347_.hurtMarked = false;
+                            p_36347_.setDeltaMovement(vec3);
+                         }
+                         // CraftBukkit end
+                      }
+
+                      if (flag2) {
+                         this.level()
+                                 .playSound(null, this.getX(), this.getY(), this.getZ(), SoundEvents.PLAYER_ATTACK_CRIT, this.getSoundSource(), 1.0F, 1.0F);
+                         this.crit(p_36347_);
+                      }
+
+                      if (!flag2 && !flag3) {
+                         if (flag) {
+                            this.level()
+                                    .playSound(null, this.getX(), this.getY(), this.getZ(), SoundEvents.PLAYER_ATTACK_STRONG, this.getSoundSource(), 1.0F, 1.0F);
+                         } else {
+                            this.level()
+                                    .playSound(null, this.getX(), this.getY(), this.getZ(), SoundEvents.PLAYER_ATTACK_WEAK, this.getSoundSource(), 1.0F, 1.0F);
+                         }
+                      }
+
+                      if (f1 > 0.0F) {
+                         this.magicCrit(p_36347_);
+                      }
+
+                      this.setLastHurtMob(p_36347_);
+                      if (p_36347_ instanceof LivingEntity) {
+                         EnchantmentHelper.doPostHurtEffects((LivingEntity) p_36347_, this);
+                      }
+
+                      EnchantmentHelper.doPostDamageEffects(this, p_36347_);
+                      ItemStack itemstack1 = this.getMainHandItem();
+                      Entity entity = p_36347_;
+                      if (p_36347_ instanceof net.minecraftforge.entity.PartEntity<?> part) {
+                         entity = part.getParent();
+                      }
+
+                      if (!this.level().isClientSide && !itemstack1.isEmpty() && entity instanceof LivingEntity) {
+                         ItemStack copy = itemstack1.copy();
+                         itemstack1.hurtEnemy((LivingEntity) entity, this);
+                         if (itemstack1.isEmpty()) {
+                            net.minecraftforge.event.ForgeEventFactory.onPlayerDestroyItem(this, copy, InteractionHand.MAIN_HAND);
+                            this.setItemInHand(InteractionHand.MAIN_HAND, ItemStack.EMPTY);
+                         }
+                      }
+
+                      if (p_36347_ instanceof LivingEntity) {
+                         float f5 = f4 - ((LivingEntity) p_36347_).getHealth();
+                         this.awardStat(Stats.DAMAGE_DEALT, Math.round(f5 * 10.0F));
+                         if (j > 0) {
+                            // CraftBukkit start - Call a combust event when somebody hits with a fire enchanted item
+                            EntityCombustByEntityEvent combustEvent = new EntityCombustByEntityEvent(this.getBukkitEntity(), entity.getBukkitEntity(), j * 4);
+                            org.bukkit.Bukkit.getPluginManager().callEvent(combustEvent);
+
+                            if (!combustEvent.isCancelled()) {
+                               entity.igniteForSeconds(combustEvent.getDuration(), false);
+                            }
+                            // CraftBukkit end
+                         }
+
+                         if (this.level() instanceof ServerLevel && f5 > 2.0F) {
+                            int k = (int) ((double) f5 * 0.5);
+                            ((ServerLevel) this.level())
+                                    .sendParticles(
                                             ParticleTypes.DAMAGE_INDICATOR, p_36347_.getX(), p_36347_.getY(0.5), p_36347_.getZ(), k, 0.1, 0.0, 0.1, 0.2
-                                        );
-                                }
-                            }
+                                    );
+                         }
+                      }
 
-                            this.causeFoodExhaustion(0.1F);
-                        } else {
-                            this.level().playSound(null, this.getX(), this.getY(), this.getZ(), SoundEvents.PLAYER_ATTACK_NODAMAGE, this.getSoundSource(), 1.0F, 1.0F);
-                            if (flag4) {
-                                p_36347_.clearFire();
-                            }
-                        }
-                    }
+                      this.exhaustionReason(EntityExhaustionEvent.ExhaustionReason.ATTACK); // CraftBukkit - EntityExhaustionEvent
+                      this.causeFoodExhaustion(level().spigotConfig.combatExhaustion);
+                   } else {
+                      this.level().playSound((Player) null, this.getX(), this.getY(), this.getZ(), SoundEvents.PLAYER_ATTACK_NODAMAGE, this.getSoundSource(), 1.0F, 1.0F);
+                      if (flag4) {
+                         p_36347_.clearFire();
+                      }
+                      // CraftBukkit start - resync on cancelled event
+                      if (this instanceof ServerPlayer) {
+                         ((ServerPlayer) this).getBukkitEntity().updateInventory();
+                      }
+                      // CraftBukkit end
+                   }
                 }
-            }
-        }
+                // this.resetAttackStrengthTicker(); // FORGE: Moved from beginning of attack() so that getAttackStrengthScale() returns an accurate value during all attack events // Mohist TODO
+
+             }
+          }
+       }
     }
 
     @Override
@@ -1305,7 +_,7 @@
     }
 
     public void disableShield() {
-        this.getCooldowns().addCooldown(Items.SHIELD, 100);
+        this.getCooldowns().addCooldown(this.getUseItem().getItem(), 100);
         this.stopUsingItem();
         this.level().broadcastEntityEvent(this, (byte)30);
     }
@@ -1364,6 +_,12 @@
         return this.containerMenu != this.inventoryMenu;
     }
 
+   protected AtomicBoolean startSleepInBed_force = new AtomicBoolean(false);
+   public Player forceSleepInBed(boolean force) {
+      startSleepInBed_force.set(force);
+      return this;
+   }
+
     public Either<Player.BedSleepingProblem, Unit> startSleepInBed(BlockPos p_36203_) {
         this.startSleeping(p_36203_);
         this.sleepCounter = 0;
@@ -1371,6 +_,7 @@
     }
 
     public void stopSleepInBed(boolean p_36226_, boolean p_36227_) {
+        net.minecraftforge.event.ForgeEventFactory.onPlayerWakeup(this, p_36226_, p_36227_);
         super.stopSleeping();
         if (this.level() instanceof ServerLevel && p_36227_) {
             ((ServerLevel)this.level()).updateSleepingPlayerList();
@@ -1399,7 +_,7 @@
         } else if (block instanceof BedBlock && BedBlock.canSetSpawn(p_36131_)) {
             return BedBlock.findStandUpPosition(EntityType.PLAYER, p_36131_, p_36132_, blockstate.getValue(BedBlock.FACING), p_36133_);
         } else if (!p_36134_) {
-            return Optional.empty();
+            return blockstate.getRespawnPosition(EntityType.PLAYER, p_36131_, p_36132_, p_36133_, null);
         } else {
             boolean flag = block.isPossibleToRespawnInThis(blockstate);
             BlockState blockstate1 = p_36131_.getBlockState(p_36132_.above());
@@ -1453,16 +_,18 @@
         return 0;
     }
 
-    @Override
-    public void jumpFromGround() {
-        super.jumpFromGround();
-        this.awardStat(Stats.JUMP);
-        if (this.isSprinting()) {
-            this.causeFoodExhaustion(0.2F);
-        } else {
-            this.causeFoodExhaustion(0.05F);
-        }
-    }
+   public void jumpFromGround() {
+      super.jumpFromGround();
+      this.awardStat(Stats.JUMP);
+      if (this.isSprinting()) {
+         this.exhaustionReason(EntityExhaustionEvent.ExhaustionReason.JUMP_SPRINT); // CraftBukkit - EntityExhaustionEvent
+         this.causeFoodExhaustion(0.2F);
+      } else {
+         this.exhaustionReason(EntityExhaustionEvent.ExhaustionReason.JUMP); // CraftBukkit - EntityExhaustionEvent
+         this.causeFoodExhaustion(0.05F);
+      }
+
+   }
 
     @Override
     public void travel(Vec3 p_36359_) {
@@ -1483,7 +_,11 @@
             Vec3 vec31 = this.getDeltaMovement();
             this.setDeltaMovement(vec31.x, d2 * 0.6, vec31.z);
             this.resetFallDistance();
-            this.setSharedFlag(7, false);
+            // CraftBukkit start
+            if (getSharedFlag(7) && !org.bukkit.craftbukkit.event.CraftEventFactory.callToggleGlideEvent(this, false).isCancelled()) {
+                this.setSharedFlag(7, false);
+            }
+            // CraftBukkit end
         } else {
             super.travel(p_36359_);
         }
@@ -1510,6 +_,7 @@
     @Override
     public boolean causeFallDamage(float p_150093_, float p_150094_, DamageSource p_150095_) {
         if (this.abilities.mayfly) {
+            net.minecraftforge.event.ForgeEventFactory.onPlayerFall(this, p_150093_, p_150093_);
             return false;
         } else {
             if (p_150093_ >= 2.0F) {
@@ -1529,7 +_,7 @@
     public boolean tryToStartFallFlying() {
         if (!this.onGround() && !this.isFallFlying() && !this.isInWater() && !this.hasEffect(MobEffects.LEVITATION)) {
             ItemStack itemstack = this.getItemBySlot(EquipmentSlot.CHEST);
-            if (itemstack.is(Items.ELYTRA) && ElytraItem.isFlyEnabled(itemstack)) {
+            if (itemstack.canElytraFly(this)) {
                 this.startFallFlying();
                 return true;
             }
@@ -1539,14 +_,25 @@
     }
 
     public void startFallFlying() {
-        this.setSharedFlag(7, true);
-    }
-
-    public void stopFallFlying() {
-        this.setSharedFlag(7, true);
-        this.setSharedFlag(7, false);
-    }
-
+      // CraftBukkit start
+      if (!org.bukkit.craftbukkit.event.CraftEventFactory.callToggleGlideEvent(this, true).isCancelled()) {
+         this.setSharedFlag(7, true);
+      } else {
+         // SPIGOT-5542: must toggle like below
+         this.setSharedFlag(7, true);
+         this.setSharedFlag(7, false);
+      }
+      // CraftBukkit end
+   }
+
+   public void stopFallFlying() {
+      // CraftBukkit start
+      if (!org.bukkit.craftbukkit.event.CraftEventFactory.callToggleGlideEvent(this, false).isCancelled()) {
+         this.setSharedFlag(7, true);
+         this.setSharedFlag(7, false);
+      }
+      // CraftBukkit end
+   }
     @Override
     protected void doWaterSplashEffect() {
         if (!this.isSpectator()) {
@@ -1558,13 +_,13 @@
     protected void playStepSound(BlockPos p_282121_, BlockState p_282194_) {
         if (this.isInWater()) {
             this.waterSwimSound();
-            this.playMuffledStepSound(p_282194_);
+            this.playMuffledStepSound(p_282194_, p_282121_);
         } else {
             BlockPos blockpos = this.getPrimaryStepSoundBlockPos(p_282121_);
             if (!p_282121_.equals(blockpos)) {
                 BlockState blockstate = this.level().getBlockState(blockpos);
                 if (blockstate.is(BlockTags.COMBINATION_STEP_SOUND_BLOCKS)) {
-                    this.playCombinationStepSounds(blockstate, p_282194_);
+                    this.playCombinationStepSounds(blockstate, p_282194_, blockpos, p_282121_);
                 } else {
                     super.playStepSound(blockpos, blockstate);
                 }
@@ -1595,6 +_,12 @@
     }
 
     public void giveExperiencePoints(int p_36291_) {
+        var event = net.minecraftforge.event.ForgeEventFactory.onPlayerXpChange(this, p_36291_);
+        if (event.isCanceled()) {
+            return;
+        }
+        p_36291_ = event.getAmount();
+
         this.increaseScore(p_36291_);
         this.experienceProgress = this.experienceProgress + (float)p_36291_ / (float)this.getXpNeededForNextLevel();
         this.totalExperience = Mth.clamp(this.totalExperience + p_36291_, 0, Integer.MAX_VALUE);
@@ -1622,7 +_,7 @@
     }
 
     public void onEnchantmentPerformed(ItemStack p_36172_, int p_36173_) {
-        this.experienceLevel -= p_36173_;
+        giveExperienceLevels(-p_36173_);
         if (this.experienceLevel < 0) {
             this.experienceLevel = 0;
             this.experienceProgress = 0.0F;
@@ -1633,6 +_,12 @@
     }
 
     public void giveExperienceLevels(int p_36276_) {
+        var event = net.minecraftforge.event.ForgeEventFactory.onPlayerLevelChange(this, p_36276_);
+        if (event.isCanceled()) {
+            return;
+        }
+        p_36276_ = event.getLevels();
+
         this.experienceLevel += p_36276_;
         if (this.experienceLevel < 0) {
             this.experienceLevel = 0;
@@ -1658,10 +_,29 @@
     public void causeFoodExhaustion(float p_36400_) {
         if (!this.abilities.invulnerable) {
             if (!this.level().isClientSide) {
-                this.foodData.addExhaustion(p_36400_);
+                // CraftBukkit start
+                EntityExhaustionEvent event = CraftEventFactory.callPlayerExhaustionEvent(this, this.reason.getAndSet(EntityExhaustionEvent.ExhaustionReason.UNKNOWN), p_36400_);
+                if (!event.isCancelled()) {
+                    this.foodData.addExhaustion(event.getExhaustion());
+                }
+                // CraftBukkit end
             }
+
         }
     }
+
+   // Mohist start
+   // CraftBukkit start
+   private AtomicReference<EntityExhaustionEvent.ExhaustionReason> reason = new AtomicReference<>(EntityExhaustionEvent.ExhaustionReason.UNKNOWN);
+   public void exhaustionReason(EntityExhaustionEvent.ExhaustionReason exhaustionReason) {
+      reason.set(exhaustionReason);
+   }
+   public void causeFoodExhaustion(float f, EntityExhaustionEvent.ExhaustionReason reason) {
+      this.exhaustionReason(reason);
+      causeFoodExhaustion(f);
+   }
+   // CraftBukkit end
+   // Mohist end
 
     public Optional<WardenSpawnTracker> getWardenSpawnTracker() {
         return Optional.empty();
@@ -1758,6 +_,15 @@
         }
     }
 
+   // Mohist start
+   // CraftBukkit start
+   public void setItemSlot(EquipmentSlot enumitemslot, ItemStack itemstack, boolean silent) {
+      this.silent0.set(silent);
+      setItemSlot(enumitemslot, itemstack);
+   }
+   // CraftBukkit end
+   // Mohist end
+
     public boolean addItem(ItemStack p_36357_) {
         return this.inventory.add(p_36357_);
     }
@@ -1795,26 +_,40 @@
 
     protected void removeEntitiesOnShoulder() {
         if (this.timeEntitySatOnShoulder + 20L < this.level().getGameTime()) {
-            this.respawnEntityOnShoulder(this.getShoulderEntityLeft());
+         // CraftBukkit start
+         if (this.spawnEntityFromShoulder(this.getShoulderEntityLeft())) {
             this.setShoulderEntityLeft(new CompoundTag());
-            this.respawnEntityOnShoulder(this.getShoulderEntityRight());
+         }
+         if (this.spawnEntityFromShoulder(this.getShoulderEntityRight())) {
             this.setShoulderEntityRight(new CompoundTag());
-        }
-    }
-
-    private void respawnEntityOnShoulder(CompoundTag p_36371_) {
-        if (!this.level().isClientSide && !p_36371_.isEmpty()) {
-            EntityType.create(p_36371_, this.level()).ifPresent(p_327053_ -> {
-                if (p_327053_ instanceof TamableAnimal) {
-                    ((TamableAnimal)p_327053_).setOwnerUUID(this.uuid);
-                }
-
-                p_327053_.setPos(this.getX(), this.getY() + 0.7F, this.getZ());
-                ((ServerLevel)this.level()).addWithUUID(p_327053_);
-            });
-        }
-    }
-
+         }
+         // CraftBukkit end
+      }
+
+   }
+
+   // Mohist start
+   public AtomicBoolean spawnEntityFromShoulder = new AtomicBoolean(true);
+
+   private void respawnEntityOnShoulder(CompoundTag p_36371_) {
+      if (!this.level.isClientSide && !p_36371_.isEmpty()) {
+         EntityType.create(p_36371_, this.level).ifPresent((p_276001_) -> {
+            if (p_276001_ instanceof TamableAnimal) {
+               ((TamableAnimal)p_276001_).setOwnerUUID(this.uuid);
+            }
+
+            p_276001_.setPos(this.getX(), this.getY() + (double)0.7F, this.getZ());
+            boolean canAdd = ((ServerLevel)this.level).addWithUUID(p_276001_);
+            spawnEntityFromShoulder.set(canAdd);
+         });
+      }
+   }
+
+   private boolean spawnEntityFromShoulder(CompoundTag pEntityCompound) { // CraftBukkit void->boolean
+      respawnEntityOnShoulder(pEntityCompound);
+      return spawnEntityFromShoulder.getAndSet(true);
+   }
+   // Mohist end
     @Override
     public abstract boolean isSpectator();
 
@@ -1841,7 +_,13 @@
 
     @Override
     public Component getDisplayName() {
-        MutableComponent mutablecomponent = PlayerTeam.formatNameForTeam(this.getTeam(), this.getName());
+        if (this.displayname == null) {
+            this.displayname = net.minecraftforge.event.ForgeEventFactory.getPlayerDisplayName(this, this.getName());
+        }
+        MutableComponent mutablecomponent = Component.literal("");
+        mutablecomponent = prefixes.stream().reduce(mutablecomponent, MutableComponent::append);
+        mutablecomponent = mutablecomponent.append(PlayerTeam.formatNameForTeam(this.getTeam(), this.displayname));
+        mutablecomponent = suffixes.stream().reduce(mutablecomponent, MutableComponent::append);
         return this.decorateDisplayNameComponent(mutablecomponent);
     }
 
@@ -1937,7 +_,7 @@
         return this.entityData.get(DATA_SHOULDER_LEFT);
     }
 
-    protected void setShoulderEntityLeft(CompoundTag p_36363_) {
+    public void setShoulderEntityLeft(CompoundTag p_36363_) {
         this.entityData.set(DATA_SHOULDER_LEFT, p_36363_);
     }
 
@@ -1945,7 +_,7 @@
         return this.entityData.get(DATA_SHOULDER_RIGHT);
     }
 
-    protected void setShoulderEntityRight(CompoundTag p_36365_) {
+    public void setShoulderEntityRight(CompoundTag p_36365_) {
         this.entityData.set(DATA_SHOULDER_RIGHT, p_36365_);
     }
 
@@ -2002,18 +_,19 @@
             Predicate<ItemStack> predicate = ((ProjectileWeaponItem)p_36349_.getItem()).getSupportedHeldProjectiles();
             ItemStack itemstack = ProjectileWeaponItem.getHeldProjectile(this, predicate);
             if (!itemstack.isEmpty()) {
-                return itemstack;
+                return net.minecraftforge.common.ForgeHooks.getProjectile(this, p_36349_, itemstack);
             } else {
                 predicate = ((ProjectileWeaponItem)p_36349_.getItem()).getAllSupportedProjectiles();
 
                 for (int i = 0; i < this.inventory.getContainerSize(); i++) {
                     ItemStack itemstack1 = this.inventory.getItem(i);
                     if (predicate.test(itemstack1)) {
-                        return itemstack1;
+                        return net.minecraftforge.common.ForgeHooks.getProjectile(this, p_36349_, itemstack1);
                     }
                 }
 
-                return this.abilities.instabuild ? new ItemStack(Items.ARROW) : ItemStack.EMPTY;
+                var vanilla = this.abilities.instabuild ? new ItemStack(Items.ARROW) : ItemStack.EMPTY;
+                return net.minecraftforge.common.ForgeHooks.getProjectile(this, p_36349_, vanilla);
             }
         }
     }
@@ -2147,6 +_,65 @@
         this.currentImpulseImpactPos = null;
         this.ignoreFallDamageFromCurrentImpulse = false;
     }
+
+    public Collection<MutableComponent> getPrefixes() {
+        return this.prefixes;
+    }
+
+    public Collection<MutableComponent> getSuffixes() {
+        return this.suffixes;
+    }
+
+    private Component displayname = null;
+
+    /**
+     * Force the displayed name to refresh, by firing {@link net.minecraftforge.event.entity.player.PlayerEvent.NameFormat}, using the real player name as event parameter.
+     */
+    public void refreshDisplayName() {
+        this.displayname = net.minecraftforge.event.ForgeEventFactory.getPlayerDisplayName(this, this.getName());
+    }
+
+    private final net.minecraftforge.common.util.LazyOptional<net.minecraftforge.items.IItemHandler>
+        playerMainHandler = net.minecraftforge.common.util.LazyOptional.of(
+            () -> new net.minecraftforge.items.wrapper.PlayerMainInvWrapper(inventory));
+
+    private final net.minecraftforge.common.util.LazyOptional<net.minecraftforge.items.IItemHandler>
+        playerEquipmentHandler = net.minecraftforge.common.util.LazyOptional.of(
+            () -> new net.minecraftforge.items.wrapper.CombinedInvWrapper(
+                  new net.minecraftforge.items.wrapper.PlayerArmorInvWrapper(inventory),
+                  new net.minecraftforge.items.wrapper.PlayerOffhandInvWrapper(inventory)));
+
+    private final net.minecraftforge.common.util.LazyOptional<net.minecraftforge.items.IItemHandler>
+        playerJoinedHandler = net.minecraftforge.common.util.LazyOptional.of(
+            () -> new net.minecraftforge.items.wrapper.PlayerInvWrapper(inventory));
+
+    @Override
+    public <T> net.minecraftforge.common.util.LazyOptional<T> getCapability(net.minecraftforge.common.capabilities.Capability<T> capability, @Nullable Direction facing) {
+        if (capability == net.minecraftforge.common.capabilities.ForgeCapabilities.ITEM_HANDLER && this.isAlive()) {
+            if (facing == null) return playerJoinedHandler.cast();
+            else if (facing.getAxis().isVertical()) return playerMainHandler.cast();
+            else if (facing.getAxis().isHorizontal()) return playerEquipmentHandler.cast();
+        }
+        return super.getCapability(capability, facing);
+    }
+
+    /**
+     * Force a pose for the player. If set, the vanilla pose determination and clearance check is skipped. Make sure the pose is clear yourself (e.g. in PlayerTick).
+     * This has to be set just once, do not set it every tick.
+     * Make sure to clear (null) the pose if not required anymore and only use if necessary.
+     */
+    public void setForcedPose(@Nullable Pose pose) {
+        this.forcedPose = pose;
+    }
+
+    /**
+     * @return The forced pose if set, null otherwise
+     */
+    @Nullable
+    public Pose getForcedPose() {
+        return this.forcedPose;
+    }
+
 
     public static enum BedSleepingProblem {
         NOT_POSSIBLE_HERE,
