--- a/net/minecraft/world/inventory/AbstractContainerMenu.java
+++ b/net/minecraft/world/inventory/AbstractContainerMenu.java
@@ -8,7 +_,10 @@
 import com.mojang.logging.LogUtils;
 import it.unimi.dsi.fastutil.ints.IntArrayList;
 import it.unimi.dsi.fastutil.ints.IntList;
+
+import java.util.HashMap;
 import java.util.List;
+import java.util.Map;
 import java.util.Optional;
 import java.util.OptionalInt;
 import java.util.Set;
@@ -19,6 +_,9 @@
 import net.minecraft.ReportedException;
 import net.minecraft.core.NonNullList;
 import net.minecraft.core.registries.BuiltInRegistries;
+import net.minecraft.network.chat.Component;
+import net.minecraft.network.protocol.game.ClientboundContainerSetSlotPacket;
+import net.minecraft.resources.ResourceLocation;
 import net.minecraft.server.level.ServerPlayer;
 import net.minecraft.util.Mth;
 import net.minecraft.world.Container;
@@ -29,6 +_,14 @@
 import net.minecraft.world.item.ItemStack;
 import net.minecraft.world.level.block.Block;
 import net.minecraft.world.level.block.entity.BlockEntity;
+import net.minecraftforge.registries.ForgeRegistries;
+import org.bukkit.craftbukkit.v1_20_R3.entity.CraftHumanEntity;
+import org.bukkit.craftbukkit.v1_20_R3.inventory.CraftInventory;
+import org.bukkit.craftbukkit.v1_20_R3.inventory.CraftItemStack;
+import org.bukkit.event.Event.Result;
+import org.bukkit.event.inventory.InventoryDragEvent;
+import org.bukkit.event.inventory.InventoryType;
+import org.bukkit.inventory.InventoryView;
 import org.slf4j.Logger;
 
 public abstract class AbstractContainerMenu {
@@ -60,6 +_,41 @@
    private ContainerSynchronizer synchronizer;
    private boolean suppressRemoteUpdates;
 
+   // CraftBukkit start
+   public boolean checkReachable = true;
+   // Mohist start
+   public InventoryView bukkitView = null;
+
+   public InventoryView getBukkitView(){
+      return bukkitView;
+   }
+
+   // Mohist end
+   public void transferTo(AbstractContainerMenu other, CraftHumanEntity player) {
+      InventoryView source = this.getBukkitView(), destination = other.getBukkitView();
+      ((CraftInventory) source.getTopInventory()).getInventory().onClose(player);
+      ((CraftInventory) source.getBottomInventory()).getInventory().onClose(player);
+      ((CraftInventory) destination.getTopInventory()).getInventory().onOpen(player);
+      ((CraftInventory) destination.getBottomInventory()).getInventory().onOpen(player);
+   }
+   private Component title;
+   public Component getTitle() {
+      // Mohist: null title -> empty title
+      if (this.title == null) {
+         if (this.menuType != null) {
+            ResourceLocation key = ForgeRegistries.MENU_TYPES.getKey(this.menuType);
+            return Component.translatable(key.toString());
+         } else {
+            this.title = Component.literal(this.toString());
+         }
+      }
+      return this.title;
+   }
+   public void setTitle(Component title) {
+      this.title = title;
+   }
+   // CraftBukkit end
+
    protected AbstractContainerMenu(@Nullable MenuType<?> p_38851_, int p_38852_) {
       this.menuType = p_38851_;
       this.containerId = p_38852_;
@@ -229,6 +_,8 @@
             ItemStack itemstack1 = p_150438_.get();
             this.remoteSlots.set(p_150436_, itemstack1);
             if (this.synchronizer != null) {
+               // Forge: Only synchronize a slot change if the itemstack actually changed in a way that is relevant to the client (i.e. share tag changed)
+               if (!p_150437_.equals(itemstack, true))
                this.synchronizer.sendSlotChange(this, p_150436_, itemstack1);
             }
          }
@@ -332,34 +_,72 @@
             }
          } else if (this.quickcraftStatus == 2) {
             if (!this.quickcraftSlots.isEmpty()) {
-               if (this.quickcraftSlots.size() == 1) {
+               if (false && this.quickcraftSlots.size() == 1) { // CraftBukkit - treat everything as a drag since we are unable to easily call InventoryClickEvent instead
                   int i1 = (this.quickcraftSlots.iterator().next()).index;
                   this.resetQuickCraft();
                   this.doClick(i1, this.quickcraftType, ClickType.PICKUP, p_150434_);
                   return;
                }
 
-               ItemStack itemstack3 = this.getCarried().copy();
-               if (itemstack3.isEmpty()) {
+               ItemStack itemstack2 = this.getCarried().copy();
+               if (itemstack2.isEmpty()) {
                   this.resetQuickCraft();
                   return;
                }
 
                int k1 = this.getCarried().getCount();
 
+               Map<Integer, ItemStack> draggedSlots = new HashMap<>(); // CraftBukkit - Store slots from drag in map (raw slot id -> new stack)
                for(Slot slot1 : this.quickcraftSlots) {
                   ItemStack itemstack1 = this.getCarried();
                   if (slot1 != null && canItemQuickReplace(slot1, itemstack1, true) && slot1.mayPlace(itemstack1) && (this.quickcraftType == 2 || itemstack1.getCount() >= this.quickcraftSlots.size()) && this.canDragTo(slot1)) {
                      int j = slot1.hasItem() ? slot1.getItem().getCount() : 0;
-                     int k = Math.min(itemstack3.getMaxStackSize(), slot1.getMaxStackSize(itemstack3));
-                     int l = Math.min(getQuickCraftPlaceCount(this.quickcraftSlots, this.quickcraftType, itemstack3) + j, k);
+                     int k = Math.min(itemstack2.getMaxStackSize(), slot1.getMaxStackSize(itemstack2));
+                     int l = Math.min(getQuickCraftPlaceCount(this.quickcraftSlots, this.quickcraftType, itemstack2) + j, k);
                      k1 -= l - j;
-                     slot1.setByPlayer(itemstack3.copyWithCount(l));
-                  }
-               }
-
-               itemstack3.setCount(k1);
-               this.setCarried(itemstack3);
+
+                     // slot1.setByPlayer(itemstack2.copyWithCount(l));
+                     draggedSlots.put(slot1.index, itemstack2.copyWithCount(l)); // CraftBukkit - Put in map instead of setting
+                  }
+               }
+
+               // CraftBukkit start - InventoryDragEvent
+               InventoryView view = this.getBukkitView();
+               org.bukkit.inventory.ItemStack newcursor = CraftItemStack.asCraftMirror(itemstack2);
+               newcursor.setAmount(k1);
+               Map<Integer, org.bukkit.inventory.ItemStack> eventmap = new HashMap<>();
+               for (Map.Entry<Integer, ItemStack> ditem : draggedSlots.entrySet()) {
+                  eventmap.put(ditem.getKey(), CraftItemStack.asBukkitCopy(ditem.getValue()));
+               }
+
+               // It's essential that we set the cursor to the new value here to prevent item duplication if a plugin closes the inventory.
+               ItemStack oldCursor = this.getCarried();
+               this.setCarried(CraftItemStack.asNMSCopy(newcursor));
+
+               InventoryDragEvent event = new InventoryDragEvent(view, (newcursor.getType() != org.bukkit.Material.AIR ? newcursor : null), CraftItemStack.asBukkitCopy(oldCursor), this.quickcraftType == 1, eventmap);
+               p_150434_.level().getCraftServer().getPluginManager().callEvent(event);
+
+               // Whether or not a change was made to the inventory that requires an update.
+               boolean needsUpdate = event.getResult() != Result.DEFAULT;
+
+               if (event.getResult() != Result.DENY) {
+                  for (Map.Entry<Integer, ItemStack> dslot : draggedSlots.entrySet()) {
+                     view.setItem(dslot.getKey(), CraftItemStack.asBukkitCopy(dslot.getValue()));
+                  }
+                  // The only time the carried item will be set to null is if the inventory is closed by the server.
+                  // If the inventory is closed by the server, then the cursor items are dropped.  This is why we change the cursor early.
+                  if (this.getCarried() != null) {
+                     this.setCarried(CraftItemStack.asNMSCopy(event.getCursor()));
+                     needsUpdate = true;
+                  }
+               } else {
+                  this.setCarried(oldCursor);
+               }
+
+               if (needsUpdate && p_150434_ instanceof ServerPlayer) {
+                  this.sendAllDataToRemote();
+               }
+               // CraftBukkit end
             }
 
             this.resetQuickCraft();
@@ -373,8 +_,11 @@
          if (p_150431_ == -999) {
             if (!this.getCarried().isEmpty()) {
                if (clickaction == ClickAction.PRIMARY) {
-                  p_150434_.drop(this.getCarried(), true);
+                  // CraftBukkit start
+                  ItemStack carried = this.getCarried();
                   this.setCarried(ItemStack.EMPTY);
+                  p_150434_.drop(carried, true);
+                  // CraftBukkit end
                } else {
                   p_150434_.drop(this.getCarried().split(1), true);
                }
@@ -401,6 +_,7 @@
             ItemStack itemstack10 = this.getCarried();
             p_150434_.updateTutorialInventoryAction(itemstack10, slot7.getItem(), clickaction);
             if (!this.tryItemClickBehaviourOverride(p_150434_, clickaction, slot7, itemstack9, itemstack10)) {
+            if (!net.minecraftforge.common.ForgeHooks.onItemStackedOn(itemstack9, itemstack10, slot7, clickaction, p_150434_, createCarriedSlotAccess()))
                if (itemstack9.isEmpty()) {
                   if (!itemstack10.isEmpty()) {
                      int i3 = clickaction == ClickAction.PRIMARY ? itemstack10.getCount() : 1;
@@ -433,64 +_,73 @@
             }
 
             slot7.setChanged();
+            // CraftBukkit start - Make sure the client has the right slot contents
+            if (p_150434_ instanceof ServerPlayer serverPlayer && slot7.getMaxStackSize() != 64) {
+               serverPlayer.connection.send(new ClientboundContainerSetSlotPacket(this.containerId, this.incrementStateId(), slot7.index, slot7.getItem()));
+               // Updating a crafting inventory makes the client reset the result slot, have to send it again
+               if (this.getBukkitView().getType() == InventoryType.WORKBENCH || this.getBukkitView().getType() == InventoryType.CRAFTING) {
+                  serverPlayer.connection.send(new ClientboundContainerSetSlotPacket(this.containerId, this.incrementStateId(), 0, this.getSlot(0).getItem()));
+               }
+            }
+            // CraftBukkit end
          }
-      } else if (p_150433_ == ClickType.SWAP && (p_150432_ >= 0 && p_150432_ < 9 || p_150432_ == 40)) {
-         ItemStack itemstack2 = inventory.getItem(p_150432_);
-         Slot slot5 = this.slots.get(p_150431_);
-         ItemStack itemstack7 = slot5.getItem();
-         if (!itemstack2.isEmpty() || !itemstack7.isEmpty()) {
-            if (itemstack2.isEmpty()) {
-               if (slot5.mayPickup(p_150434_)) {
-                  inventory.setItem(p_150432_, itemstack7);
-                  slot5.onSwapCraft(itemstack7.getCount());
-                  slot5.setByPlayer(ItemStack.EMPTY);
-                  slot5.onTake(p_150434_, itemstack7);
+      } else if (p_150433_ == ClickType.SWAP) {
+         Slot slot2 = this.slots.get(p_150431_);
+         ItemStack itemstack3 = inventory.getItem(p_150432_);
+         ItemStack itemstack6 = slot2.getItem();
+         if (!itemstack3.isEmpty() || !itemstack6.isEmpty()) {
+            if (itemstack3.isEmpty()) {
+               if (slot2.mayPickup(p_150434_)) {
+                  inventory.setItem(p_150432_, itemstack6);
+                  slot2.onSwapCraft(itemstack6.getCount());
+                  slot2.setByPlayer(ItemStack.EMPTY);
+                  slot2.onTake(p_150434_, itemstack6);
                }
-            } else if (itemstack7.isEmpty()) {
-               if (slot5.mayPlace(itemstack2)) {
-                  int j2 = slot5.getMaxStackSize(itemstack2);
-                  if (itemstack2.getCount() > j2) {
-                     slot5.setByPlayer(itemstack2.split(j2));
+            } else if (itemstack6.isEmpty()) {
+               if (slot2.mayPlace(itemstack3)) {
+                  int i2 = slot2.getMaxStackSize(itemstack3);
+                  if (itemstack3.getCount() > i2) {
+                     slot2.setByPlayer(itemstack3.split(i2));
                   } else {
                      inventory.setItem(p_150432_, ItemStack.EMPTY);
-                     slot5.setByPlayer(itemstack2);
+                     slot2.setByPlayer(itemstack3);
                   }
                }
-            } else if (slot5.mayPickup(p_150434_) && slot5.mayPlace(itemstack2)) {
-               int k2 = slot5.getMaxStackSize(itemstack2);
-               if (itemstack2.getCount() > k2) {
-                  slot5.setByPlayer(itemstack2.split(k2));
-                  slot5.onTake(p_150434_, itemstack7);
-                  if (!inventory.add(itemstack7)) {
-                     p_150434_.drop(itemstack7, true);
+            } else if (slot2.mayPickup(p_150434_) && slot2.mayPlace(itemstack3)) {
+               int j2 = slot2.getMaxStackSize(itemstack3);
+               if (itemstack3.getCount() > j2) {
+                  slot2.setByPlayer(itemstack3.split(j2));
+                  slot2.onTake(p_150434_, itemstack6);
+                  if (!inventory.add(itemstack6)) {
+                     p_150434_.drop(itemstack6, true);
                   }
                } else {
-                  inventory.setItem(p_150432_, itemstack7);
-                  slot5.setByPlayer(itemstack2);
-                  slot5.onTake(p_150434_, itemstack7);
+                  inventory.setItem(p_150432_, itemstack6);
+                  slot2.setByPlayer(itemstack3);
+                  slot2.onTake(p_150434_, itemstack6);
                }
             }
          }
       } else if (p_150433_ == ClickType.CLONE && p_150434_.getAbilities().instabuild && this.getCarried().isEmpty() && p_150431_ >= 0) {
-         Slot slot4 = this.slots.get(p_150431_);
-         if (slot4.hasItem()) {
-            ItemStack itemstack5 = slot4.getItem();
+         Slot slot5 = this.slots.get(p_150431_);
+         if (slot5.hasItem()) {
+            ItemStack itemstack5 = slot5.getItem();
             this.setCarried(itemstack5.copyWithCount(itemstack5.getMaxStackSize()));
          }
       } else if (p_150433_ == ClickType.THROW && this.getCarried().isEmpty() && p_150431_ >= 0) {
-         Slot slot3 = this.slots.get(p_150431_);
-         int j1 = p_150432_ == 0 ? 1 : slot3.getItem().getCount();
-         ItemStack itemstack6 = slot3.safeTake(j1, Integer.MAX_VALUE, p_150434_);
-         p_150434_.drop(itemstack6, true);
+         Slot slot4 = this.slots.get(p_150431_);
+         int j1 = p_150432_ == 0 ? 1 : slot4.getItem().getCount();
+         ItemStack itemstack7 = slot4.safeTake(j1, Integer.MAX_VALUE, p_150434_);
+         p_150434_.drop(itemstack7, true);
       } else if (p_150433_ == ClickType.PICKUP_ALL && p_150431_ >= 0) {
-         Slot slot2 = this.slots.get(p_150431_);
+         Slot slot3 = this.slots.get(p_150431_);
          ItemStack itemstack4 = this.getCarried();
-         if (!itemstack4.isEmpty() && (!slot2.hasItem() || !slot2.mayPickup(p_150434_))) {
+         if (!itemstack4.isEmpty() && (!slot3.hasItem() || !slot3.mayPickup(p_150434_))) {
             int l1 = p_150432_ == 0 ? 0 : this.slots.size() - 1;
-            int i2 = p_150432_ == 0 ? 1 : -1;
+            int k2 = p_150432_ == 0 ? 1 : -1;
 
             for(int l2 = 0; l2 < 2; ++l2) {
-               for(int l3 = l1; l3 >= 0 && l3 < this.slots.size() && itemstack4.getCount() < itemstack4.getMaxStackSize(); l3 += i2) {
+               for(int l3 = l1; l3 >= 0 && l3 < this.slots.size() && itemstack4.getCount() < itemstack4.getMaxStackSize(); l3 += k2) {
                   Slot slot8 = this.slots.get(l3);
                   if (slot8.hasItem() && canItemQuickReplace(slot8, itemstack4, true) && slot8.mayPickup(p_150434_) && this.canTakeItemForPickAll(itemstack4, slot8)) {
                      ItemStack itemstack11 = slot8.getItem();
@@ -536,13 +_,14 @@
       if (p_38940_ instanceof ServerPlayer) {
          ItemStack itemstack = this.getCarried();
          if (!itemstack.isEmpty()) {
+            this.setCarried(ItemStack.EMPTY); // CraftBukkit - SPIGOT-4556 - from below
             if (p_38940_.isAlive() && !((ServerPlayer)p_38940_).hasDisconnected()) {
                p_38940_.getInventory().placeItemBackInInventory(itemstack);
             } else {
                p_38940_.drop(itemstack, false);
             }
 
-            this.setCarried(ItemStack.EMPTY);
+            // this.setCarried(ItemStack.EMPTY); // CraftBukkit - moved up
          }
       }
 
@@ -610,14 +_,15 @@
             ItemStack itemstack = slot.getItem();
             if (!itemstack.isEmpty() && ItemStack.isSameItemSameTags(p_38904_, itemstack)) {
                int j = itemstack.getCount() + p_38904_.getCount();
-               if (j <= p_38904_.getMaxStackSize()) {
+               int maxSize = Math.min(slot.getMaxStackSize(), p_38904_.getMaxStackSize());
+               if (j <= maxSize) {
                   p_38904_.setCount(0);
                   itemstack.setCount(j);
                   slot.setChanged();
                   flag = true;
-               } else if (itemstack.getCount() < p_38904_.getMaxStackSize()) {
-                  p_38904_.shrink(p_38904_.getMaxStackSize() - itemstack.getCount());
-                  itemstack.setCount(p_38904_.getMaxStackSize());
+               } else if (itemstack.getCount() < maxSize) {
+                  p_38904_.shrink(maxSize - itemstack.getCount());
+                  itemstack.setCount(maxSize);
                   slot.setChanged();
                   flag = true;
                }
@@ -718,7 +_,7 @@
             i = 1;
             break;
          case 2:
-            i = p_279172_.getItem().getMaxStackSize();
+            i = p_279172_.getMaxStackSize();
             break;
          default:
             i = p_279172_.getCount();
@@ -807,4 +_,13 @@
       this.stateId = this.stateId + 1 & 32767;
       return this.stateId;
    }
+
+   // CraftBukkit start
+   public void broadcastCarriedItem() {
+      this.remoteCarried = this.getCarried().copy();
+      if (this.synchronizer != null) {
+         this.synchronizer.sendCarriedChange(this, this.remoteCarried);
+      }
+   }
+   // CraftBukkit end
 }
